name: Build ImmortalWrt

on:
    schedule:
        - cron: '0 0 * * *'
    workflow_dispatch:
        

jobs:
    build:
        runs-on: ubuntu-22.04
        strategy:
          matrix:
            target:
              - cr6608-full
              - cr6608-mini


        steps:
            - name: checkout repo
              uses: actions/checkout@v4

            - name: set up build toolchain
              run: |
                sudo apt update
                sudo apt install build-essential file libncurses-dev zlib1g-dev gawk git \
                    gettext libssl-dev xsltproc rsync wget unzip python3 python3-distutils    
                wget https://downloads.immortalwrt.org/snapshots/targets/ramips/mt7621/immortalwrt-imagebuilder-ramips-mt7621.Linux-x86_64.tar.zst
                tar --zstd -xvf immortalwrt-imagebuilder-ramips-mt7621.Linux-x86_64.tar.zst                

            - name: Parse configuration
              id: config  
              run: |
                    CONFIG=configs/${{ matrix.target }}.config
                    PROFILE=$(grep '^PROFILE=' "$CONFIG" | cut -d= -f2-)
                    PACKAGES=$(grep '^PACKAGES=' "$CONFIG" | cut -d= -f2-)
                    echo "profile=$PROFILE" >> $GITHUB_OUTPUT
                    echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

            - name: build image
              working-directory: immortalwrt-imagebuilder-ramips-mt7621.Linux-x86_64
              run: |
                make image PROFILE=${{ steps.config.outputs.profile }} PACKAGES="${{ steps.config.outputs.packages }}"

            - name: upload artifact
              uses: actions/upload-artifact@v4
              with:
                name: ${{ matrix.target }}-firmware-${{ github.run_id }}
                path: immortalwrt-imagebuilder-ramips-mt7621.Linux-x86_64/bin/targets/ramips/mt7621/   
